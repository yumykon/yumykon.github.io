<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cards Widget</title>
  <style>
    :root{
      --bg: transparent;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --muted: rgba(0,0,0,.55);
      --border: rgba(0,0,0,.10);
      --shadow: 0 10px 22px rgba(0,0,0,.12);
      --radius: 18px;
      --accent: #6c63ff;
    }

    * { box-sizing: border-box; }

    html, body{
      margin:0;
      padding:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    .panel{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px;
      border-bottom: 1px solid var(--border);
    }

    .title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .controls{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      width: 100%;
    }

    @media (min-width: 720px){
      .controls{ width: auto; }
    }

    .search{
      position: relative;
      flex: 1 1 220px;
      max-width: 320px;
    }

    .search input{
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 13px;
    }

    .search input:focus{
      border-color: rgba(108,99,255,.45);
      box-shadow: 0 0 0 3px rgba(108,99,255,.12);
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip{
      user-select: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: background .15s, transform .15s, border-color .15s;
      white-space: nowrap;
    }

    .chip:hover{ transform: translateY(-1px); }

    .chip[data-active="true"]{
      border-color: rgba(108,99,255,.55);
      background: rgba(108,99,255,.10);
    }

    .grid{
      padding: 14px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }

    @media (min-width: 900px){
      .grid{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }

    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      transition: transform .15s, box-shadow .15s;
      outline: none;
    }

    .card:hover,
    .card:focus-visible{
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
    }

    .thumb{
      width: 100%;
      aspect-ratio: 3 / 4;
      background: #f4f4f4;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .meta{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }

    .name{
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rarity{
      font-size: 11px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 6px;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      flex: 0 0 auto;
      opacity: .85;
    }

    .empty{
      padding: 28px 14px 34px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modal[data-open="true"]{ display:flex; }

    .modal-inner{
      width: min(980px, 100%);
      max-height: 92vh;
      background: #101010;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      display:flex;
      flex-direction: column;
    }

    .modal-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.4);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .modal-title{
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .close{
      appearance: none;
      border: 0;
      background: rgba(255,255,255,.10);
      color: #fff;
      border-radius: 12px;
      width: 34px;
      height: 34px;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-weight: 800;
      font-size: 18px;
      line-height: 1;
    }

    .close:hover{ background: rgba(255,255,255,.18); }
    .close:focus-visible{ outline: 2px solid rgba(108,99,255,.7); outline-offset: 2px; }

    .modal-body{
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap: 0;
      background:#0b0b0b;
      flex:1;
      min-height: 0;
    }

    @media (max-width: 820px){
      .modal-body{ grid-template-columns: 1fr; }
    }

    .modal-media{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      min-height: 0;
    }

    .modal-media img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      max-height: 82vh;
      display:block;
      border-radius: 12px;
    }

    .modal-info{
      border-left: 1px solid rgba(255,255,255,.08);
      padding: 14px;
      color: rgba(255,255,255,.92);
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      overflow: auto;
    }

    @media (max-width: 820px){
      .modal-info{ border-left: 0; border-top: 1px solid rgba(255,255,255,.08); }
    }

    .modal-badges{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }

    .badge .dot{ opacity: 1; }

    .desc{
      margin: 0;
      font-size: 13px;
      line-height: 1.55;
      color: rgba(255,255,255,.82);
      white-space: pre-wrap;
    }

    .desc[data-empty="true"]{ color: rgba(255,255,255,.55); }

    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      .card, .chip { transition: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="panel">
      <div class="topbar">
        <div class="title">Collectible Cards</div>
        <div class="controls">
          <div class="search">
            <input id="q" type="text" inputmode="search" autocomplete="off" placeholder="Search by name…" />
          </div>
          <div class="chips" id="chips"></div>
        </div>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No cards found.</div>
    </div>
  </div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-inner" id="modalInner" role="dialog" aria-modal="true" aria-label="Card preview">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Card</div>
        <button class="close" id="closeBtn" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-media">
          <img id="modalImg" alt="" />
        </div>
        <div class="modal-info">
          <div class="modal-badges">
            <span class="badge" id="modalRarityBadge">
              <span class="dot" id="modalRarityDot"></span>
              <span id="modalRarityText">Rarity</span>
            </span>
          </div>
          <p class="desc" id="modalDesc" data-empty="true">No description.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- config ----------
    // Paths: this file lives at /embed/cards.html
    // Use ../ so it works on GitHub Pages (and avoids double /images/cards/)
    const DATA_URL = "../data/cards.json";
    const IMG_BASE = "../images/cards/";

    const RARITIES = ["All", "Legendary", "Lewd", "Rare", "Uncommon", "Common"]; // order matters

    // ---------- state ----------
    let allCards = [];
    let activeRarity = "All";
    let query = "";

    // ---------- elements ----------
    const elGrid = document.getElementById("grid");
    const elEmpty = document.getElementById("empty");
    const elQ = document.getElementById("q");
    const elChips = document.getElementById("chips");

    const elModal = document.getElementById("modal");
    const elModalInner = document.getElementById("modalInner");
    const elModalImg = document.getElementById("modalImg");
    const elModalTitle = document.getElementById("modalTitle");
    const elCloseBtn = document.getElementById("closeBtn");
    const elModalDesc = document.getElementById("modalDesc");
    const elModalRarityDot = document.getElementById("modalRarityDot");
    const elModalRarityText = document.getElementById("modalRarityText");

    function rarityDotColor(r){
      switch(String(r||"").trim().toLowerCase()){
        case "legendary": return "#ffb703";
        case "lewd": return "#ff4d8d";
        case "rare": return "#4da3ff";
        case "uncommon": return "#54d38a";
        case "common": return "#9aa1ad";
        default: return "var(--accent)";
      }
    }

    function normalize(s){
      return String(s||"")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .trim();
    }

    // Avoid double paths when JSON already includes "images/cards/..." etc.
    function resolveImageUrl(image){
      const raw = String(image || "").trim();
      if(!raw) return "";
      // absolute URLs
      if(/^https?:\/\//i.test(raw)) return raw;
      // already an absolute path
      if(raw.startsWith("/")) return raw;
      // already a relative path
      if(raw.startsWith("images/") || raw.startsWith("../") || raw.startsWith("./")) return raw;
      // default: treat as filename under IMG_BASE
      return IMG_BASE + raw;
    }

    function buildChips(){
      elChips.innerHTML = "";
      for(const r of RARITIES){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip";
        b.textContent = r;
        b.dataset.active = (r === activeRarity) ? "true" : "false";
        b.addEventListener("click", () => {
          activeRarity = r;
          // update chip states
          for(const c of elChips.querySelectorAll(".chip")){
            c.dataset.active = (c.textContent === activeRarity) ? "true" : "false";
          }
          render();
        });
        elChips.appendChild(b);
      }
    }

    function filterCards(){
      const qn = normalize(query);
      const activeNorm = normalize(activeRarity);

      return allCards.filter(c => {
        const rarityNorm = normalize(c.rarity);
        const rOk = (activeNorm === "all") || (rarityNorm === activeNorm);
        if(!rOk) return false;
        if(!qn) return true;
        return normalize(c.name).includes(qn);
      });
    }

    function openModal(c, imgUrl){
      elModal.dataset.open = "true";
      elModal.setAttribute("aria-hidden", "false");

      const rarityLabel = String(c.rarity || "").trim();
      elModalTitle.textContent = `${c.name}${rarityLabel ? " • " + rarityLabel : ""}`;

      elModalImg.src = imgUrl;
      elModalImg.alt = c.name;

      elModalRarityDot.style.background = rarityDotColor(c.rarity);
      elModalRarityText.textContent = rarityLabel || "Unknown";

      const desc = String(c.description || "").trim();
      if(desc){
        elModalDesc.textContent = desc;
        elModalDesc.dataset.empty = "false";
      } else {
        elModalDesc.textContent = "No description.";
        elModalDesc.dataset.empty = "true";
      }

      // lock scroll inside iframe
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";

      window.__sendResize && window.__sendResize(true);
    }

    function render(){
      const list = filterCards();
      elGrid.innerHTML = "";
      elEmpty.style.display = list.length ? "none" : "block";

      for(const c of list){
        const card = document.createElement("div");
        card.className = "card";
        card.tabIndex = 0;

        const imgUrl = resolveImageUrl(c.image);

        card.innerHTML = `
          <div class="thumb">
            <img loading="lazy" src="${imgUrl}" alt="${c.name}" />
          </div>
          <div class="meta">
            <div class="name" title="${c.name}">${c.name}</div>
            <div class="rarity"><span class="dot" style="background:${rarityDotColor(c.rarity)}"></span>${c.rarity || ""}</div>
          </div>
        `;

        const open = () => openModal(c, imgUrl);

        card.addEventListener("click", open);
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            open();
          }
        });

        elGrid.appendChild(card);
      }

      // nudge resize after render
      requestAnimationFrame(() => window.__sendResize && window.__sendResize(true));
    }

    function closeModal(){
      elModal.dataset.open = "false";
      elModal.setAttribute("aria-hidden", "true");
      elModalImg.src = "";
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      window.__sendResize && window.__sendResize(true);
    }

    // Close button
    elCloseBtn.addEventListener("click", closeModal);

    // Close by clicking outside the dialog (anywhere on the dark overlay)
    elModal.addEventListener("mousedown", (e) => {
      if(elModal.dataset.open !== "true") return;
      if(!elModalInner.contains(e.target)) closeModal();
    });

    // Escape closes
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && elModal.dataset.open === "true") closeModal();
    });

    elQ.addEventListener("input", (e) => {
      query = e.target.value;
      render();
    });

    async function init(){
      buildChips();
      try{
        const r = await fetch(DATA_URL, { cache: "no-store" });
        const data = await r.json();

        // Support both shapes:
        // { cards: [...] } (project) OR { items: [...] } (alt)
        const raw = Array.isArray(data.cards) ? data.cards : (Array.isArray(data.items) ? data.items : []);

        allCards = raw
          .filter(x => x && x.image)
          .map(x => ({
            name: x.name || x.title || "Untitled",
            rarity: String(x.rarity || "").trim(),
            image: x.image,
            description: (x.description ?? x.desc ?? x.text ?? "")
          }));

        render();
      } catch(err){
        console.error(err);
        elGrid.innerHTML = "";
        elEmpty.style.display = "block";
        elEmpty.textContent = "Failed to load cards.";
      }
    }

    init();
  </script>

  <!-- Auto-resize for Carrd via postMessage -->
  <script>
    (function () {
      const PARENT_ORIGIN = "https://yumykon.com";
      const TYPE = "yumykon:resize";
      const FRAME_ID = "cardsFrame";

      function getHeight(){
        const doc = document.documentElement;
        const body = document.body;
        return Math.max(
          doc.scrollHeight, doc.offsetHeight, doc.clientHeight,
          body ? body.scrollHeight : 0,
          body ? body.offsetHeight : 0
        );
      }

      let last = 0;
      function send(force=false){
        const h = getHeight();
        if(!force && Math.abs(h - last) < 2) return;
        last = h;
        if(window.parent){
          window.parent.postMessage({ type: TYPE, id: FRAME_ID, height: h }, PARENT_ORIGIN);
        }
      }

      // Expose for the app to nudge resizes after renders
      window.__sendResize = send;

      window.addEventListener("load", () => send(true));
      window.addEventListener("resize", () => send(true));

      const ro = new ResizeObserver(() => send());
      ro.observe(document.documentElement);

      const mo = new MutationObserver(() => send());
      mo.observe(document.documentElement, { childList:true, subtree:true, attributes:true });

      document.addEventListener("DOMContentLoaded", () => {
        send(true);
        setTimeout(() => send(true), 200);
        setTimeout(() => send(true), 800);
      });
    })();
  </script>
</body>
</html>
