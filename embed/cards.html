<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cards Widget</title>
  <style>
    :root{
      --bg: transparent;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --muted: rgba(0,0,0,.55);
      --border: rgba(0,0,0,.10);
      --shadow: 0 10px 22px rgba(0,0,0,.12);
      --radius: 40px;
      --accent: #6c63ff;
    }

    * { box-sizing: border-box; }

    html, body{
      margin:0;
      padding:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
    }

    .panel{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 14px;
      border-bottom: 1px solid var(--border);
    }

    .title{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .controls{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      width: 100%;
    }

    @media (min-width: 720px){
      .controls{ width: auto; }
    }

    .search{
      position: relative;
      flex: 1 1 220px;
      max-width: 320px;
    }

    .search input{
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      outline: none;
      font-size: 13px;
    }

    .search input:focus{
      border-color: rgba(108,99,255,.45);
      box-shadow: 0 0 0 3px rgba(108,99,255,.12);
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip{
      user-select: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: background .15s, transform .15s, border-color .15s;
      white-space: nowrap;
    }

    .chip:hover{ transform: translateY(-1px); }

    .chip[data-active="true"]{
      border-color: rgba(108,99,255,.55);
      background: rgba(108,99,255,.10);
    }

    .grid{
      padding: 14px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }

    @media (min-width: 900px){
      .grid{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }

    .card{
      --rx: 0deg;
      --ry: 0deg;
      --tx: 0px;
      --ty: 0px;
      --lift: 0px;

      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      outline: none;

      transform: translate3d(var(--tx), calc(var(--ty) + var(--lift)), 0)
                 rotateX(var(--rx)) rotateY(var(--ry));
      transform-style: preserve-3d;
      will-change: transform;
      transition: transform .15s, box-shadow .15s;
    }

    .card:hover,
    .card:focus-visible{
      --lift: -4px;
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
    }

    /* rarity visual effects (MODAL ONLY) */
    .modal-fx{
      position:absolute;
      inset:0;
      pointer-events:none;
      mix-blend-mode: overlay;
      border-radius: 40px;
    }

    /* Uncommon: Legendary palette, linear diagonal, NO animation (parallax only) */
    /* Uncommon: Legendary palette (like Legendary), linear diagonal, no animation (parallax only) */
    .modal-fx.arcane{
      mix-blend-mode: screen;
      opacity: .78;

      background:
        /* soft specular sweep */
        linear-gradient(135deg,
          rgba(255,255,255,.22),
          rgba(255,255,255,0) 40%,
          rgba(255,255,255,.18) 70%,
          rgba(255,255,255,0) 100%),
        /* main prismatic band */
        linear-gradient(135deg,
          rgba(255, 0, 0, .62),
          rgba(255, 127, 0, .56),
          rgba(255, 255, 0, .48),
          rgba(0, 255, 0, .48),
          rgba(0, 0, 255, .56),
          rgba(75, 0, 130, .60),
          rgba(148, 0, 211, .62)
        );

      background-size: 220% 220%, 240% 240%;
      background-position:
        calc(50% + (var(--fxX, 0px) * 0.6)) calc(50% + (var(--fxY, 0px) * 0.6)),
        calc(50% + var(--fxX, 0px)) calc(50% + var(--fxY, 0px));

      animation: none;
      filter: saturate(1.45) brightness(1.10) contrast(1.05);
    }

    /* subtle glitter */
    .modal-fx.arcane::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity: .22;

      background-image:
        radial-gradient(circle at 14px 18px, rgba(255,255,255,.85) 0 1px, transparent 2px),
        radial-gradient(circle at 56px 44px, rgba(255,255,255,.70) 0 1px, transparent 2px),
        radial-gradient(circle at 92px 28px, rgba(255,255,255,.75) 0 .9px, transparent 2px),
        radial-gradient(circle at 24px 92px, rgba(255,255,255,.65) 0 1px, transparent 2px),
        radial-gradient(circle at 102px 104px, rgba(255,255,255,.60) 0 .9px, transparent 2px);

      background-size: 120px 120px;
      background-repeat: repeat;
      filter: blur(.25px);
    }

    /* micro-stripes for “foil feel” */
    .modal-fx.arcane::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: .10;
      mix-blend-mode: overlay;

      background: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,.55) 0 2px,
        rgba(255,255,255,0) 2px 10px
      );
    }


    .modal-fx.holo{
      /* Lewd: pink/red foil with lust/heart vibe */
      background:
        linear-gradient(120deg,
          rgba(255, 40, 120, .45),
          rgba(255, 90, 90, .35),
          rgba(255, 0, 120, .45),
          rgba(255, 40, 120, .45)),
        linear-gradient(135deg,
          rgba(255,255,255,.18),
          rgba(255,255,255,0) 60%);
      background-size: 400% 400%, 200% 200%;
      animation: lewdSheen 6s linear infinite;
    }

    /* outlined translucent hearts overlay */
    .modal-fx.holo::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background-color: rgba(255, 60, 141, 0.84);
      mask-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><path d='M60 95 C20 65,10 40,30 25 C45 15,60 30,60 30 C60 30,75 15,90 25 C110 40,100 65,60 95 Z' fill='none' stroke='white' stroke-width='10' stroke-linejoin='round'/></svg>");
      mask-size: 120px 120px;
      mask-repeat: repeat;
      mix-blend-mode: screen;
      transform-origin: 50% 50%;
      animation: heartsDrift 10s linear infinite;
      opacity: .65;
    }

    /* Rare: Prismatic Dust (sparkly particle drift) */
    .modal-fx.dust{
      mix-blend-mode: screen;
      opacity: .45;
      background:
        radial-gradient(circle at 30% 35%, rgba(140, 210, 255, .35), transparent 55%),
        radial-gradient(circle at 70% 65%, rgba(170, 120, 255, .28), transparent 60%);
      animation: dustGlow 10s ease-in-out infinite;
    }

    .modal-fx.dust::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 12px 18px, rgba(160,230,255,.70) 0 1px, transparent 2px),
        radial-gradient(circle at 54px 42px, rgba(210,170,255,.65) 0 1px, transparent 2px),
        radial-gradient(circle at 88px 26px, rgba(120,255,220,.60) 0 1px, transparent 2px),
        radial-gradient(circle at 28px 86px, rgba(255,255,255,.55) 0 1px, transparent 2px),
        radial-gradient(circle at 96px 92px, rgba(140,210,255,.55) 0 1px, transparent 2px),
        radial-gradient(circle at 18px 64px, rgba(210,170,255,.50) 0 1px, transparent 2px);
      background-size: 120px 120px;
      background-repeat: repeat;
      opacity: .75;
      filter: blur(.15px);
      animation: dustDrift 8.5s linear infinite;
      mix-blend-mode: screen;
    }

    .modal-fx.dust::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 16px 22px, rgba(255,255,255,.50) 0 .8px, transparent 2px),
        radial-gradient(circle at 44px 70px, rgba(160,230,255,.45) 0 .8px, transparent 2px),
        radial-gradient(circle at 92px 58px, rgba(210,170,255,.40) 0 .8px, transparent 2px);
      background-size: 92px 92px;
      background-repeat: repeat;
      opacity: .55;
      animation: dustDrift2 14s linear infinite;
      mix-blend-mode: screen;
    }

    @keyframes dustGlow{
      0%{ filter: saturate(1.05) brightness(1.00); }
      50%{ filter: saturate(1.35) brightness(1.06); }
      100%{ filter: saturate(1.05) brightness(1.00); }
    }

    @keyframes dustDrift{
      0%{ background-position: 0 0; }
      100%{ background-position: -160px 160px; }
    }

    @keyframes dustDrift2{
      0%{ background-position: 0 0; }
      100%{ background-position: 120px 240px; }
    }

    .modal-fx.foil{
      background: linear-gradient(135deg,
        rgba(255,255,255,.35),
        rgba(180,180,180,.15),
        rgba(255,255,255,.35));
    }

    .modal-fx.poly{
      background: conic-gradient(
        from 0deg,
        #ff0000, #ff7f00, #ffff00, #00ff00,
        #0000ff, #4b0082, #9400d3, #ff0000
      );
      transform: scale(1.35) rotate(0deg);
      transform-origin: 50% 50%;
      animation: polySpin 6s linear infinite;
      mix-blend-mode: overlay;
      opacity: .45;
    }

    @keyframes lewdSheen{
      0%{ background-position: 0% 50%, 0% 0%; }
      50%{ background-position: 100% 50%, 100% 100%; }
      100%{ background-position: 0% 50%, 0% 0%; }
    }

    @keyframes heartsDrift{
      0%{
        transform: rotate(45deg) translate3d(0,0,0) scale(1);
      }
      100%{
        transform: rotate(45deg) translate3d(-120px,120px,0) scale(1);
      }
    }

    @keyframes polySpin{
      0%   { transform: scale(2) rotate(0deg); }
      100% { transform: scale(2) rotate(360deg); }
    }

    .thumb{
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4;
      background: #f4f4f4;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .thumb img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .meta{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }

    .name{
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .rarity{
      font-size: 11px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 6px;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      flex: 0 0 auto;
      opacity: .85;
    }

    .empty{
      padding: 28px 14px 34px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
    }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }

    .modal[data-open="true"]{ display:flex; }

    .modal-inner{
      width: min(980px, 100%);
      max-height: 92vh;
      background: #101010;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.45);
      display:flex;
      flex-direction: column;
    }

    .modal-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.4);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .modal-title{
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .close{
      appearance: none;
      border: 0;
      background: rgba(255,255,255,.10);
      color: #fff;
      border-radius: 12px;
      width: 34px;
      height: 34px;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-weight: 800;
      font-size: 18px;
      line-height: 1;
    }

    .close:hover{ background: rgba(255,255,255,.18); }
    .close:focus-visible{ outline: 2px solid rgba(108,99,255,.7); outline-offset: 2px; }

    .modal-body{
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap: 0;
      background:#0b0b0b;
      flex:1;
      min-height: 0;
    }

    @media (max-width: 820px){
      .modal-body{ grid-template-columns: 1fr; }
    }

    .modal-media{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      min-height: 0;
    }

    .modal-card-tilt{
      --mrx: 0deg;
      --mry: 0deg;
      --mx: 0px;
      --my: 0px;

      width: fit-content;
      max-width: min(520px, 100%);
      max-height: 82vh;
      display:flex;
      align-items:center;
      justify-content:center;

      transform-style: preserve-3d;
      will-change: transform;
      transform: translate3d(var(--mx), var(--my), 0) rotateX(var(--mrx)) rotateY(var(--mry));
      transition: transform 120ms ease;

      pointer-events: auto;
    }

    .modal-card-float{
      position: relative;
      border-radius: 40px;
      box-sizing: border-box;
      overflow: hidden;

      width: fit-content;
      height: fit-content;
      max-width: min(520px, 100%);
      max-height: 82vh;

      display:flex;
      align-items:center;
      justify-content:center;

      animation: modalFloat 3.6s ease-in-out infinite;
      animation-play-state: running;
      pointer-events: none;
    }

    @keyframes modalFloat{
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .modal-card-float img{
      width: auto;
      height: auto;
      max-width: 100%;
      max-height: 82vh;
      object-fit: contain;
      display:block;
      border-radius: 40px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55));
      pointer-events: none;
    }

    .modal-info{
      border-left: 1px solid rgba(255,255,255,.08);
      padding: 14px;
      color: rgba(255,255,255,.92);
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      overflow: auto;
    }

    @media (max-width: 820px){
      .modal-info{ border-left: 0; border-top: 1px solid rgba(255,255,255,.08); }
    }

    .modal-badges{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }

    .badge .dot{ opacity: 1; }

    .desc{
      margin: 0;
      font-size: 13px;
      line-height: 1.55;
      color: rgba(255,255,255,.82);
      white-space: pre-wrap;
    }

    .desc[data-empty="true"]{ color: rgba(255,255,255,.55); }

    @media (prefers-reduced-motion: reduce){
      .card, .chip { transition: none; }
      .card{ transform: none; }
      .modal-card-tilt{ transition: none; transform: none; }
      .modal-card-float{ animation: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="panel">
      <div class="topbar">
        <div class="title">Collectible Cards</div>
        <div class="controls">
          <div class="search">
            <input id="q" type="text" inputmode="search" autocomplete="off" placeholder="Search by name…" />
          </div>
          <div class="chips" id="chips"></div>
        </div>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No cards found.</div>
    </div>
  </div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-inner" id="modalInner" role="dialog" aria-modal="true" aria-label="Card preview">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Card</div>
        <button class="close" id="closeBtn" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-media">
          <div class="modal-card-tilt" id="modalCardTilt" aria-hidden="true">
            <div class="modal-card-float" id="modalCardFloat">
              <img id="modalImg" alt="" />
              <div id="modalFx" class="modal-fx" aria-hidden="true"></div>
            </div>
          </div>
        </div>
        <div class="modal-info">
          <div class="modal-badges">
            <span class="badge" id="modalRarityBadge">
              <span class="dot" id="modalRarityDot"></span>
              <span id="modalRarityText">Rarity</span>
            </span>
          </div>
          <p class="desc" id="modalDesc" data-empty="true">No description.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- config ----------
    const DATA_URL = "../data/cards.json";
    const IMG_BASE = "../images/cards/";
    const RARITIES = ["All", "Legendary", "Lewd", "Rare", "Uncommon", "Common"];

    // ---------- state ----------
    let allCards = [];
    let activeRarity = "All";
    let query = "";

    // ---------- elements ----------
    const elGrid = document.getElementById("grid");
    const elEmpty = document.getElementById("empty");
    const elQ = document.getElementById("q");
    const elChips = document.getElementById("chips");

    const elModal = document.getElementById("modal");
    const elModalInner = document.getElementById("modalInner");
    const elModalImg = document.getElementById("modalImg");
    const elModalTitle = document.getElementById("modalTitle");
    const elModalCardTilt = document.getElementById("modalCardTilt");
    const elModalCardFloat = document.getElementById("modalCardFloat");
    const elModalFx = document.getElementById("modalFx");
    const elCloseBtn = document.getElementById("closeBtn");
    const elModalDesc = document.getElementById("modalDesc");
    const elModalRarityDot = document.getElementById("modalRarityDot");
    const elModalRarityText = document.getElementById("modalRarityText");

    function rarityDotColor(r){
      switch(String(r||"").trim().toLowerCase()){
        case "legendary": return "#ffb703";
        case "lewd": return "#ff4d8d";
        case "rare": return "#4da3ff";
        case "uncommon": return "#54d38a";
        case "common": return "#9aa1ad";
        default: return "var(--accent)";
      }
    }

    function normalize(s){
      return String(s||"")
        .toLowerCase()
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .trim();
    }

    function resolveImageUrl(image){
      const raw = String(image || "").trim();
      if(!raw) return "";
      if(/^https?:\/\//i.test(raw)) return raw;
      if(raw.startsWith("/")) return raw;
      if(raw.startsWith("images/") || raw.startsWith("../") || raw.startsWith("./")) return raw;
      return IMG_BASE + raw;
    }

    function buildChips(){
      elChips.innerHTML = "";
      for(const r of RARITIES){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "chip";
        b.textContent = r;
        b.dataset.active = (r === activeRarity) ? "true" : "false";
        b.addEventListener("click", () => {
          activeRarity = r;
          for(const c of elChips.querySelectorAll(".chip")){
            c.dataset.active = (c.textContent === activeRarity) ? "true" : "false";
          }
          render();
        });
        elChips.appendChild(b);
      }
    }

    function filterCards(){
      const qn = normalize(query);
      const activeNorm = normalize(activeRarity);

      return allCards.filter(c => {
        const rarityNorm = normalize(c.rarity);
        const rOk = (activeNorm === "all") || (rarityNorm === activeNorm);
        if(!rOk) return false;
        if(!qn) return true;
        return normalize(c.name).includes(qn);
      });
    }

    function openModal(c, imgUrl){
      elModal.dataset.open = "true";
      elModal.setAttribute("aria-hidden", "false");

      const rarityLabel = String(c.rarity || "").trim();
      elModalTitle.textContent = `${c.name}${rarityLabel ? " • " + rarityLabel : ""}`;

      elModalImg.src = imgUrl;
      elModalImg.alt = c.name;

      elModalRarityDot.style.background = rarityDotColor(c.rarity);
      elModalRarityText.textContent = rarityLabel || "Unknown";

      if(elModalFx){
        elModalFx.className = "modal-fx";
        const r = normalize(c.rarity);
        if(r === "lewd") elModalFx.classList.add("holo");
        else if(r === "rare") elModalFx.classList.add("dust");
        else if(r === "uncommon") elModalFx.classList.add("arcane");
        else if(r === "legendary") elModalFx.classList.add("poly");
      }

      const desc = String(c.description || "").trim();
      if(desc){
        elModalDesc.textContent = desc;
        elModalDesc.dataset.empty = "false";
      } else {
        elModalDesc.textContent = "No description.";
        elModalDesc.dataset.empty = "true";
      }

      enableModalFX();

      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";

      window.__sendResize && window.__sendResize(true);
    }

    // --- modal FX: tilt + float on the opened card ---
    const reduceMotionGlobal = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    let modalFxOn = false;
    let modalRAF = 0;
    let modalLast = null;

    function setModalVars(nx, ny){
      const maxRot = 10;   // degrees
      const maxMove = 10;  // px

      const ry = (nx * maxRot).toFixed(2);
      const rx = (-ny * maxRot).toFixed(2);
      const mx = (nx * maxMove).toFixed(2);
      const my = (ny * maxMove).toFixed(2);

      elModalCardTilt.style.setProperty("--mry", `${ry}deg`);
      elModalCardTilt.style.setProperty("--mrx", `${rx}deg`);
      elModalCardTilt.style.setProperty("--mx", `${mx}px`);
      elModalCardTilt.style.setProperty("--my", `${my}px`);

      // FX parallax (slower than the card)
      if(elModalFx){
        const fxMove = maxMove * 0.35;
        elModalFx.style.setProperty("--fxX", `${(-nx * fxMove).toFixed(2)}px`);
        elModalFx.style.setProperty("--fxY", `${(-ny * fxMove).toFixed(2)}px`);
      }
    }

    function modalApply(){
      modalRAF = 0;
      if(!modalFxOn || !modalLast) return;
      setModalVars(modalLast.nx, modalLast.ny);
    }

    function onModalMove(e){
      if(!modalFxOn || reduceMotionGlobal) return;
      if(e.pointerType && e.pointerType === "touch") return;

      const rect = elModalCardTilt.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      const nx = (x - 0.5) * 2;
      const ny = (y - 0.5) * 2;

      modalLast = { nx, ny };
      if(!modalRAF) modalRAF = requestAnimationFrame(modalApply);
    }

    function resetModalFX(){
      modalLast = null;
      if(modalRAF){ cancelAnimationFrame(modalRAF); modalRAF = 0; }

      if(elModalCardTilt){
        elModalCardTilt.style.setProperty("--mrx", "0deg");
        elModalCardTilt.style.setProperty("--mry", "0deg");
        elModalCardTilt.style.setProperty("--mx", "0px");
        elModalCardTilt.style.setProperty("--my", "0px");
      }

      if(elModalFx){
        elModalFx.style.setProperty("--fxX", "0px");
        elModalFx.style.setProperty("--fxY", "0px");
      }
    }

    function enableModalFX(){
      if(elModalCardFloat) elModalCardFloat.style.animationPlayState = "running";
      modalFxOn = false;
      resetModalFX();
    }

    function disableModalFX(){
      modalFxOn = false;
      resetModalFX();
      if(elModalCardFloat) elModalCardFloat.style.animationPlayState = "paused";
    }

    // track mouse ONLY when hovering the card in the modal
    elModalCardTilt.addEventListener("pointerenter", () => {
      if(reduceMotionGlobal) return;
      modalFxOn = true;
    });

    elModalCardTilt.addEventListener("pointermove", onModalMove);

    elModalCardTilt.addEventListener("pointerleave", () => {
      modalFxOn = false;
      resetModalFX();
    });

    function render(){
      const list = filterCards();
      elGrid.innerHTML = "";
      elEmpty.style.display = list.length ? "none" : "block";

      for(const c of list){
        const card = document.createElement("div");
        card.className = "card";
        card.tabIndex = 0;

        const imgUrl = resolveImageUrl(c.image);

        card.innerHTML = `
          <div class="thumb">
            <img loading="lazy" src="${imgUrl}" alt="${c.name}" />
          </div>
          <div class="meta">
            <div class="name" title="${c.name}">${c.name}</div>
            <div class="rarity"><span class="dot" style="background:${rarityDotColor(c.rarity)}"></span>${c.rarity || ""}</div>
          </div>
        `;

        const open = () => openModal(c, imgUrl);

        // --- subtle "follow the mouse" tilt ---
        const reduceMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        let raf = 0;
        let last = null;

        function applyTilt(){
          raf = 0;
          if(!last) return;
          const { nx, ny } = last;

          const maxRot = 8;
          const maxMove = 3;

          const ry = (nx * maxRot).toFixed(2);
          const rx = (-ny * maxRot).toFixed(2);
          const tx = (nx * maxMove).toFixed(2);
          const ty = (ny * maxMove).toFixed(2);

          card.style.setProperty("--ry", `${ry}deg`);
          card.style.setProperty("--rx", `${rx}deg`);
          card.style.setProperty("--tx", `${tx}px`);
          card.style.setProperty("--ty", `${ty}px`);
        }

        function onMove(e){
          if(reduceMotion) return;
          if(e.pointerType && e.pointerType === "touch") return;

          const rect = card.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;
          const nx = (x - 0.5) * 2;
          const ny = (y - 0.5) * 2;

          last = { nx, ny };
          if(!raf) raf = requestAnimationFrame(applyTilt);
        }

        function onLeave(){
          last = null;
          if(raf){ cancelAnimationFrame(raf); raf = 0; }
          card.style.setProperty("--rx", "0deg");
          card.style.setProperty("--ry", "0deg");
          card.style.setProperty("--tx", "0px");
          card.style.setProperty("--ty", "0px");
        }

        card.addEventListener("pointermove", onMove);
        card.addEventListener("pointerleave", onLeave);
        card.addEventListener("blur", onLeave);

        card.addEventListener("click", open);
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            open();
          }
        });

        elGrid.appendChild(card);
      }

      requestAnimationFrame(() => window.__sendResize && window.__sendResize(true));
    }

    function closeModal(){
      elModal.dataset.open = "false";
      elModal.setAttribute("aria-hidden", "true");
      elModalImg.src = "";
      if(elModalFx) elModalFx.className = "modal-fx";

      disableModalFX();

      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      window.__sendResize && window.__sendResize(true);
    }

    elCloseBtn.addEventListener("click", closeModal);

    elModal.addEventListener("mousedown", (e) => {
      if(elModal.dataset.open !== "true") return;
      if(!elModalInner.contains(e.target)) closeModal();
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && elModal.dataset.open === "true") closeModal();
    });

    elQ.addEventListener("input", (e) => {
      query = e.target.value;
      render();
    });

    async function init(){
      buildChips();
      try{
        const r = await fetch(DATA_URL, { cache: "no-store" });
        const data = await r.json();

        const raw = Array.isArray(data.cards) ? data.cards : (Array.isArray(data.items) ? data.items : []);

        allCards = raw
          .filter(x => x && x.image)
          .map(x => ({
            name: x.name || x.title || "Untitled",
            rarity: String(x.rarity || "").trim(),
            image: x.image,
            description: (x.description ?? x.desc ?? x.text ?? "")
          }));

        render();
      } catch(err){
        console.error(err);
        elGrid.innerHTML = "";
        elEmpty.style.display = "block";
        elEmpty.textContent = "Failed to load cards.";
      }
    }

    init();
  </script>

  <!-- Auto-resize for Carrd via postMessage -->
  <script>
    (function () {
      const PARENT_ORIGIN = "https://yumykon.com";
      const TYPE = "yumykon:resize";
      const FRAME_ID = "cardsFrame";

      function getHeight(){
        const doc = document.documentElement;
        const body = document.body;
        return Math.max(
          doc.scrollHeight, doc.offsetHeight, doc.clientHeight,
          body ? body.scrollHeight : 0,
          body ? body.offsetHeight : 0
        );
      }

      let last = 0;
      function send(force=false){
        const h = getHeight();
        if(!force && Math.abs(h - last) < 2) return;
        last = h;
        if(window.parent){
          window.parent.postMessage({ type: TYPE, id: FRAME_ID, height: h }, PARENT_ORIGIN);
        }
      }

      window.__sendResize = send;

      window.addEventListener("load", () => send(true));
      window.addEventListener("resize", () => send(true));

      const ro = new ResizeObserver(() => send());
      ro.observe(document.documentElement);

      const mo = new MutationObserver(() => send());
      mo.observe(document.documentElement, { childList:true, subtree:true, attributes:true });

      document.addEventListener("DOMContentLoaded", () => {
        send(true);
        setTimeout(() => send(true), 200);
        setTimeout(() => send(true), 800);
      });
    })();
  </script>
</body>
</html>
