<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cards Admin</title>
    <meta name="robots" content="noindex, nofollow" />

    <style>
      :root {
        --bg: #070718;
        --panel: #ffffff;
        --text: #1a1a1a;
        --muted: #4b4b4b;
        --accent: #7a62ff;
        --danger: #d83144;
        --ok: #1f9d55;
        --shadow: rgba(0, 0, 0, 0.18);
        --radius: 40px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text);
        background: var(--bg) url("images/background-stars.png") repeat;
      }

      .wrap {
        min-height: 100%;
        padding: 34px 18px 70px;
        display: flex;
        justify-content: center;
      }

      .panel {
        width: min(980px, 100%);
        background: var(--panel);
        border-radius: var(--radius);
        box-shadow: 0 24px 70px var(--shadow);
        padding: 34px 30px 34px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        flex-wrap: wrap;
      }

      h1 {
        margin: 0;
        font-size: 22px;
      }

      .sub {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }

      @media (max-width: 820px) {
        .row { grid-template-columns: 1fr; }
      }

      .card {
        margin-top: 18px;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 18px;
        padding: 16px;
        background: rgba(255,255,255,0.9);
      }

      label {
        display: block;
        font-size: 12px;
        font-weight: 800;
        letter-spacing: 0.4px;
        margin-bottom: 6px;
      }

      input, select, textarea {
        width: 100%;
        border: 1px solid rgba(0,0,0,0.14);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
      }

      textarea {
        min-height: 110px;
        resize: vertical;
        line-height: 1.5;
      }

      input:focus, select:focus, textarea:focus {
        border-color: rgba(122,98,255,0.55);
        box-shadow: 0 0 0 4px rgba(122,98,255,0.12);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 999px;
        border: 2px solid rgba(122,98,255,0.55);
        background: #fff;
        color: var(--accent);
        text-decoration: none;
        font-weight: 800;
        font-size: 14px;
        cursor: pointer;
      }

      .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .btn.danger {
        background: #fff;
        color: var(--danger);
        border-color: rgba(216,49,68,0.55);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }

      .status.ok { color: var(--ok); }
      .status.err { color: var(--danger); }

      .gate {
        display: grid;
        gap: 10px;
        max-width: 460px;
        margin: 0 auto;
        text-align: center;
        padding: 16px 10px;
      }

      .hidden { display: none !important; }

      .hint {
        font-size: 12px;
        color: var(--muted);
        line-height: 1.5;
      }

      code {
        background: rgba(0,0,0,0.06);
        padding: 2px 6px;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="panel">
        <header>
          <div>
            <h1>Cards Admin</h1>
            <p class="sub">Add new collectible cards to the public gallery (updates <code>data/cards.json</code> and uploads the image to <code>images/cards/</code>).</p>
          </div>

          <a class="btn" href="cards.html">Open gallery →</a>
        </header>

        <!-- Password gate -->
        <section class="card" id="gateCard">
          <div class="gate">
            <div style="font-weight:900; font-size:16px;">Restricted access</div>
            <div class="hint">This page is static. The password gate is only meant to keep casual visitors out. Do not treat it as strong security.</div>
            <div style="text-align:left;">
              <label for="gatePassword">Password</label>
              <input id="gatePassword" type="password" autocomplete="current-password" placeholder="Enter password" />
            </div>
            <button class="btn primary" id="gateEnter">Enter</button>
            <div class="status" id="gateStatus"></div>
          </div>
        </section>

        <!-- Admin form -->
        <section class="card hidden" id="adminCard">
          <div class="row">
            <div>
              <label for="ghToken">GitHub Token</label>
              <input id="ghToken" type="password" autocomplete="off" placeholder="Fine-grained PAT (Contents: read & write)" />
              <div class="hint" style="margin-top:6px;">Token is kept only in this tab (session) and is never written to the repository.</div>
            </div>
            <div>
              <label for="repo">Repository</label>
              <input id="repo" type="text" value="yumykon/yumykon.github.io" />
              <div class="hint" style="margin-top:6px;">Format: <code>owner/repo</code></div>
            </div>
          </div>

          <hr style="border:0; border-top:1px solid rgba(0,0,0,0.08); margin:16px 0;" />

          <div class="row">
            <div>
              <label for="cardName">Card name</label>
              <input id="cardName" type="text" placeholder="e.g., Kari — Night Raid" />
            </div>
            <div>
              <label for="cardRarity">Rarity</label>
              <select id="cardRarity">
                <option value="legendary">Legendary</option>
                <option value="lewd">Lewd</option>
                <option value="rare">Rare</option>
                <option value="uncommon">Uncommon</option>
                <option value="common" selected>Common</option>
              </select>
            </div>
          </div>

          <div style="margin-top:14px;">
            <label for="cardDesc">Description (shown when opening the card)</label>
            <textarea id="cardDesc" placeholder="Write something about this card..."></textarea>
          </div>

          <div style="margin-top:14px;">
            <label for="cardImage">Card image</label>
            <input id="cardImage" type="file" accept="image/png,image/jpeg,image/webp" />
            <div class="hint" style="margin-top:6px;">Recommended: PNG, portrait, similar proportions to your cards (3:4).</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; align-items:center;">
            <button class="btn primary" id="submitBtn">Add card</button>
            <button class="btn danger" id="clearTokenBtn" type="button">Clear token</button>
            <div class="status" id="status"></div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // 1) Set your own SHA-256 password hash here (hex). See helper below.
      //    Current value is a placeholder.
      const GATE_HASH_HEX = '433f86c70d51c9614489d1097091083fe9ccfe4e2bf0ddcf6a500ed6c73ad1d1';

      const DATA_PATH = 'data/cards.json';
      const IMAGES_DIR = 'images/cards';

      const gateCard = document.getElementById('gateCard');
      const adminCard = document.getElementById('adminCard');
      const gatePassword = document.getElementById('gatePassword');
      const gateEnter = document.getElementById('gateEnter');
      const gateStatus = document.getElementById('gateStatus');

      const ghToken = document.getElementById('ghToken');
      const repoEl = document.getElementById('repo');
      const cardName = document.getElementById('cardName');
      const cardRarity = document.getElementById('cardRarity');
      const cardDesc = document.getElementById('cardDesc');
      const cardImage = document.getElementById('cardImage');
      const submitBtn = document.getElementById('submitBtn');
      const clearTokenBtn = document.getElementById('clearTokenBtn');
      const statusEl = document.getElementById('status');

      const allowedRarities = new Set(['legendary','lewd','rare','uncommon','common']);

      const sessionKey = 'cards_admin_token';
      ghToken.value = sessionStorage.getItem(sessionKey) || '';
      ghToken.addEventListener('input', () => sessionStorage.setItem(sessionKey, ghToken.value));
      clearTokenBtn.addEventListener('click', () => {
        sessionStorage.removeItem(sessionKey);
        ghToken.value = '';
        setStatus('Token cleared.', 'ok');
      });

      function setGateStatus(msg, kind) {
        gateStatus.textContent = msg || '';
        gateStatus.className = 'status' + (kind ? ' ' + kind : '');
      }

      function setStatus(msg, kind) {
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (kind ? ' ' + kind : '');
      }

      async function sha256Hex(str) {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      async function checkGate() {
        const pass = gatePassword.value || '';
        const hex = await sha256Hex(pass);
        const ok = hex.toLowerCase() === (GATE_HASH_HEX || '').toLowerCase();
        if (!ok) {
          setGateStatus('Wrong password.', 'err');
          return;
        }
        gateCard.classList.add('hidden');
        adminCard.classList.remove('hidden');
      }

      gateEnter.addEventListener('click', checkGate);
      gatePassword.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkGate();
      });

      function slugify(s) {
        return (s || '')
          .toLowerCase()
          .trim()
          .replace(/['"]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64);
      }

      function assertRepo(value) {
        const v = (value || '').trim();
        if (!/^[^/\s]+\/[^/\s]+$/.test(v)) throw new Error('Invalid repository. Use owner/repo.');
        return v;
      }

      async function ghRequest(token, method, url, body) {
        const res = await fetch(url, {
          method,
          headers: {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${token}`,
            'X-GitHub-Api-Version': '2022-11-28',
            ...(body ? { 'Content-Type': 'application/json' } : {})
          },
          body: body ? JSON.stringify(body) : undefined
        });

        if (!res.ok) {
          let details = '';
          try { details = await res.text(); } catch {}
          throw new Error(`GitHub API error (${res.status}). ${details}`);
        }
        return res.json();
      }

      async function getFile(token, repo, path) {
        const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
        return ghRequest(token, 'GET', url);
      }

      async function putFile(token, repo, path, contentBase64, message, sha) {
        const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
        const body = {
          message,
          content: contentBase64,
          ...(sha ? { sha } : {})
        };
        return ghRequest(token, 'PUT', url, body);
      }

      function toBase64(bytes) {
        let binary = '';
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
      }

      async function readJsonFromRepo(token, repo) {
        const file = await getFile(token, repo, DATA_PATH);
        const content = atob((file.content || '').replace(/\n/g, ''));
        const json = JSON.parse(content);
        return { json, sha: file.sha };
      }

      async function uploadImage(token, repo, file, id) {
        const ext = (() => {
          const t = (file.type || '').toLowerCase();
          if (t.includes('png')) return 'png';
          if (t.includes('jpeg') || t.includes('jpg')) return 'jpg';
          if (t.includes('webp')) return 'webp';
          // fallback from filename
          const m = (file.name || '').toLowerCase().match(/\.(png|jpg|jpeg|webp)$/);
          if (m) return m[1] === 'jpeg' ? 'jpg' : m[1];
          return 'png';
        })();

        const arrayBuf = await file.arrayBuffer();
        const bytes = new Uint8Array(arrayBuf);
        const b64 = toBase64(bytes);

        const imgPath = `${IMAGES_DIR}/${id}.${ext}`;
        await putFile(
          token,
          repo,
          imgPath,
          b64,
          `Add card image: ${id}`
        );

        return imgPath;
      }

      function validateForm() {
        const token = (ghToken.value || '').trim();
        if (!token) throw new Error('GitHub token is required.');

        const repo = assertRepo(repoEl.value);
        const name = (cardName.value || '').trim();
        if (!name) throw new Error('Card name is required.');

        const rarity = (cardRarity.value || 'common').trim().toLowerCase();
        if (!allowedRarities.has(rarity)) throw new Error('Invalid rarity.');

        const desc = (cardDesc.value || '').trim();

        const file = cardImage.files && cardImage.files[0];
        if (!file) throw new Error('Card image is required.');

        const idBase = slugify(name) || 'card';
        const id = `${idBase}-${Date.now()}`;

        return { token, repo, name, rarity, desc, file, id };
      }

      submitBtn.addEventListener('click', async () => {
        setStatus('', '');
        submitBtn.disabled = true;
        try {
          const { token, repo, name, rarity, desc, file, id } = validateForm();

          setStatus('Uploading image...', '');
          const imagePath = await uploadImage(token, repo, file, id);

          setStatus('Updating JSON...', '');
          const { json, sha } = await readJsonFromRepo(token, repo);
          const cards = Array.isArray(json.cards) ? json.cards : [];

          const next = {
            updated_at: new Date().toISOString(),
            cards: [
              { id, name, rarity, description: desc, image: imagePath },
              ...cards
            ]
          };

          const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(next, null, 2) + '\n')));
          await putFile(
            token,
            repo,
            DATA_PATH,
            contentB64,
            `Add card: ${name}`,
            sha
          );

          setStatus('Done! The gallery will update after GitHub Pages deploys.', 'ok');
          cardName.value = '';
          cardDesc.value = '';
          cardRarity.value = 'common';
          cardImage.value = '';
        } catch (e) {
          setStatus(e?.message || 'Something went wrong.', 'err');
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Helper: generate hash in DevTools console
      //   await sha256Hex('your_password')
    </script>
  </body>
</html>
