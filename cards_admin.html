<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cards Admin</title>
    <meta name="robots" content="noindex, nofollow" />

    <style>
      :root{
        --bg:#070718;
        --panel:#ffffff;
        --text:#141414;
        --muted:#5a5a5a;
        --accent:#7a62ff;
        --danger:#d83144;
        --ok:#1f9d55;

        --shadow:rgba(0,0,0,.22);
        --radius:28px;
        --card:rgba(255,255,255,.92);
        --stroke:rgba(0,0,0,.10);
      }

      *{box-sizing:border-box}
      html,body{height:100%}

      body{
        margin:0;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        color:var(--text);
        background:var(--bg) url("images/background-stars.png") repeat;
      }

      .wrap{
        min-height:100%;
        padding:28px 16px;
        display:flex;
        align-items:center;          /* vertical center */
        justify-content:center;      /* horizontal center */
      }

      .panel{
        width:min(920px, 100%);
        background:var(--panel);
        border-radius:var(--radius);
        box-shadow:0 28px 90px var(--shadow);
        padding:26px;
      }

      header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        flex-wrap:wrap;
        padding:2px 2px 10px;
      }

      h1{
        margin:0;
        font-size:18px;
        letter-spacing:.2px;
      }

      .btn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        padding:10px 14px;
        border-radius:999px;
        border:1px solid rgba(122,98,255,.55);
        background:#fff;
        color:var(--accent);
        text-decoration:none;
        font-weight:800;
        font-size:13px;
        cursor:pointer;
        user-select:none;
      }

      .btn.primary{
        background:var(--accent);
        color:#fff;
        border-color:var(--accent);
      }

      .btn:disabled{
        opacity:.6;
        cursor:not-allowed;
      }

      .card{
        margin-top:14px;
        border:1px solid var(--stroke);
        border-radius:22px;
        padding:18px;
        background:var(--card);
      }

      .hidden{display:none !important;}

      /* Gate (login) */
      .gate{
        max-width:520px;
        margin:0 auto;
        display:grid;
        gap:12px;
        text-align:center;
        padding:6px 4px;
      }

      .gate-title{
        font-weight:900;
        font-size:16px;
      }

      .hint{
        font-size:12px;
        color:var(--muted);
        line-height:1.5;
      }

      .gate-field{
        text-align:left;
      }

      label{
        display:block;
        font-size:11px;
        font-weight:800;
        letter-spacing:.5px;
        margin:0 0 6px;
      }

      input,select,textarea{
        width:100%;
        border:1px solid rgba(0,0,0,.14);
        border-radius:14px;
        padding:12px 12px;
        font-size:14px;
        outline:none;
        background:#fff;
      }

      textarea{
        min-height:120px;
        resize:vertical;
        line-height:1.5;
      }

      input:focus,select:focus,textarea:focus{
        border-color:rgba(122,98,255,.60);
        box-shadow:0 0 0 4px rgba(122,98,255,.12);
      }

      .status{
        margin-top:6px;
        font-size:13px;
        color:var(--muted);
        text-align:center;
      }
      .status.ok{color:var(--ok);}
      .status.err{color:var(--danger);}

      /* Admin form layout */
      .row{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:14px;
      }

      @media (max-width:820px){
        .panel{padding:18px;}
        .row{grid-template-columns:1fr;}
      }

      .divider{
        border:0;
        border-top:1px solid rgba(0,0,0,.08);
        margin:16px 0;
      }

      .actions{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        justify-content:center; /* centered actions */
        margin-top:16px;
      }

      code{
        background:rgba(0,0,0,.06);
        padding:2px 6px;
        border-radius:8px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="panel">
        <header>
          <h1>Cards Admin</h1>
          <a class="btn" href="https://yumykon.com/#cardsclub">Open gallery →</a>
        </header>

        <!-- Password gate -->
        <section class="card" id="gateCard">
          <div class="gate">
            <div class="gate-title">Restricted access</div>
            <div class="hint">Enter the password to access the admin panel.</div>

            <div class="gate-field">
              <label for="gatePassword">Password</label>
              <input id="gatePassword" type="password" autocomplete="current-password" placeholder="Enter password" />
            </div>

            <div>
              <button class="btn primary" id="gateEnter" type="button">Enter</button>
            </div>

            <div class="status" id="gateStatus"></div>
          </div>
        </section>

        <!-- Admin form -->
        <section class="card hidden" id="adminCard">
          <div class="row">
            <div>
              <label for="ghToken">Webhook</label>
              <input
                id="ghToken"
                type="text"
                autocomplete="on"
                placeholder="token after github_pat_"
              />
            </div>
            <div>
              <label for="repo">Secret</label>
              <input id="repo" type="text" value="yumykon/yumykon.github.io" disabled />
            </div>
          </div>

          <hr class="divider" />

          <div class="row">
            <div>
              <label for="cardName">Card name</label>
              <input id="cardName" type="text" placeholder="e.g., Kari — Night Raid" />
            </div>
            <div>
              <label for="cardRarity">Rarity</label>
              <select id="cardRarity">
                <option value="legendary">Legendary</option>
                <option value="lewd">Lewd</option>
                <option value="rare">Rare</option>
                <option value="uncommon">Uncommon</option>
                <option value="common" selected>Common</option>
              </select>
            </div>
          </div>

          <div style="margin-top:14px;">
            <label for="cardDesc">Description</label>
            <textarea id="cardDesc" placeholder="Write something about this card..."></textarea>
          </div>

          <div style="margin-top:14px;">
            <label for="cardImage">Card image</label>
            <input id="cardImage" type="file" accept="image/png,image/jpeg,image/webp" />
            <div class="hint" style="margin-top:6px;">Recommended: PNG, portrait, similar proportions to your cards (3:4).</div>
          </div>

          <div class="actions">
            <button class="btn primary" id="submitBtn" type="button">Add card</button>
          </div>

          <div class="status" id="status"></div>
        </section>
      </main>
    </div>

    <script>
      // Password hash (SHA-256 hex)
      const GATE_HASH_HEX = '433f86c70d51c9614489d1097091083fe9ccfe4e2bf0ddcf6a500ed6c73ad1d1';

      const DATA_PATH = 'data/cards.json';
      const IMAGES_DIR = 'images/cards';

      const gateCard = document.getElementById('gateCard');
      const adminCard = document.getElementById('adminCard');
      const gatePassword = document.getElementById('gatePassword');
      const gateEnter = document.getElementById('gateEnter');
      const gateStatus = document.getElementById('gateStatus');

      const ghTokenEl = document.getElementById('ghToken');
      const repoEl = document.getElementById('repo');
      const cardName = document.getElementById('cardName');
      const cardRarity = document.getElementById('cardRarity');
      const cardDesc = document.getElementById('cardDesc');
      const cardImage = document.getElementById('cardImage');
      const submitBtn = document.getElementById('submitBtn');
      const statusEl = document.getElementById('status');

      const GH_TOKEN_RAW = (ghTokenEl.value || '').trim();
      const PREFIX = 'github_pat_';
      const GH_TOKEN = PREFIX + GH_TOKEN_RAW;

      const allowedRarities = new Set(['legendary','lewd','rare','uncommon','common']);

      function setGateStatus(msg, kind) {
        gateStatus.textContent = msg || '';
        gateStatus.className = 'status' + (kind ? ' ' + kind : '');
      }

      function setStatus(msg, kind) {
        statusEl.textContent = msg || '';
        statusEl.className = 'status' + (kind ? ' ' + kind : '');
      }

      async function sha256Hex(str) {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      }

      async function checkGate() {
        const pass = gatePassword.value || '';
        const hex = await sha256Hex(pass);
        const ok = hex.toLowerCase() === (GATE_HASH_HEX || '').toLowerCase();
        if (!ok) {
          setGateStatus('Wrong password.', 'err');
          return;
        }
        gateCard.classList.add('hidden');
        adminCard.classList.remove('hidden');
        setGateStatus('', '');
      }

      gateEnter.addEventListener('click', checkGate);
      gatePassword.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkGate();
      });

      function slugify(s) {
        return (s || '')
          .toLowerCase()
          .trim()
          .replace(/['"]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64);
      }

      function assertRepo(value) {
        const v = (value || '').trim();
        if (!/^[^/\s]+\/[^/\s]+$/.test(v)) throw new Error('Invalid repository. Use owner/repo.');
        return v;
      }

      async function ghRequest(token, method, url, body) {
        const res = await fetch(url, {
          method,
          headers: {
            'Accept': 'application/vnd.github+json',
            'Authorization': `Bearer ${token}`,
            'X-GitHub-Api-Version': '2022-11-28',
            ...(body ? { 'Content-Type': 'application/json' } : {})
          },
          body: body ? JSON.stringify(body) : undefined
        });

        if (!res.ok) {
          let details = '';
          try { details = await res.text(); } catch {}
          throw new Error(`GitHub API error (${res.status}). ${details}`);
        }
        return res.json();
      }

      async function getFile(token, repo, path) {
        const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
        return ghRequest(token, 'GET', url);
      }

      async function putFile(token, repo, path, contentBase64, message, sha) {
        const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
        const body = { message, content: contentBase64, ...(sha ? { sha } : {}) };
        return ghRequest(token, 'PUT', url, body);
      }

      function toBase64(bytes) {
        let binary = '';
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
          binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
      }

      async function readJsonFromRepo(token, repo) {
        const file = await getFile(token, repo, DATA_PATH);
        const content = atob((file.content || '').replace(/\n/g, ''));
        const json = JSON.parse(content);
        return { json, sha: file.sha };
      }

      async function uploadImage(token, repo, file, id) {
        const ext = (() => {
          const t = (file.type || '').toLowerCase();
          if (t.includes('png')) return 'png';
          if (t.includes('jpeg') || t.includes('jpg')) return 'jpg';
          if (t.includes('webp')) return 'webp';
          const m = (file.name || '').toLowerCase().match(/\.(png|jpg|jpeg|webp)$/);
          if (m) return m[1] === 'jpeg' ? 'jpg' : m[1];
          return 'png';
        })();

        const bytes = new Uint8Array(await file.arrayBuffer());
        const b64 = toBase64(bytes);

        const relPath = `${IMAGES_DIR}/${id}.${ext}`;
        await putFile(token, repo, relPath, b64, `Add card image: ${id}`);

        return relPath;
      }

      function validateForm() {
        if (!GH_TOKEN_RAW) throw new Error('GitHub token is missing in the HTML value.');

        const token = GH_TOKEN;
        const repo = assertRepo(repoEl.value);

        const name = (cardName.value || '').trim();
        if (!name) throw new Error('Card name is required.');

        const rarity = (cardRarity.value || 'common').trim().toLowerCase();
        if (!allowedRarities.has(rarity)) throw new Error('Invalid rarity.');

        const desc = (cardDesc.value || '').trim();

        const file = cardImage.files && cardImage.files[0];
        if (!file) throw new Error('Card image is required.');

        const idBase = slugify(name) || 'card';
        const id = `${idBase}-${Date.now()}`;

        return { token, repo, name, rarity, desc, file, id };
      }

      submitBtn.addEventListener('click', async () => {
        setStatus('', '');
        submitBtn.disabled = true;

        try {
          const { token, repo, name, rarity, desc, file, id } = validateForm();

          setStatus('Uploading image...', '');
          const imagePath = await uploadImage(token, repo, file, id);

          setStatus('Updating JSON...', '');
          const { json, sha } = await readJsonFromRepo(token, repo);
          const cards = Array.isArray(json.cards) ? json.cards : [];

          const next = {
            updated_at: new Date().toISOString(),
            cards: [{ id, name, rarity, description: desc, image: imagePath }, ...cards]
          };

          const contentB64 = btoa(unescape(encodeURIComponent(JSON.stringify(next, null, 2) + '\n')));
          await putFile(token, repo, DATA_PATH, contentB64, `Add card: ${name}`, sha);

          setStatus('Done! The gallery will update after GitHub Pages deploys.', 'ok');
          cardName.value = '';
          cardDesc.value = '';
          cardRarity.value = 'common';
          cardImage.value = '';
        } catch (e) {
          setStatus(e?.message || 'Something went wrong.', 'err');
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Helper (DevTools): await sha256Hex('your_password')
    </script>
  </body>
</html>
